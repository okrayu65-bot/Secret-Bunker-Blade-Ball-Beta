-- Secret Bunker - COMPLETE FULL SCRIPT (Your Final Code + WindUI)
-- Auto Parry + Auto Spam + Manual Spam GUI (Your Exact Draggable) + Visualizer + Normal ESP

local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "Secret Bunker",
    TitleIcon = "rbxassetid://4483345998"
})

local CombatTab = Window:Tab({ Name = "Combat", Icon = "sword" })
local VisualTab = Window:Tab({ Name = "Visuals", Icon = "eye" })

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Stats = game:GetService("Stats")
local LocalPlayer = Players.LocalPlayer

-- Structures
local Balls = Workspace:WaitForChild("Balls")

-- Remote Hooking (Capture Replay)
local revertedRemotes = {}
local originalMetatables = {}

local function isValidRemoteArgs(args)
    return true
end

local function hookRemote(remote)
    if not revertedRemotes[remote] then
        if not originalMetatables[getmetatable(remote)] then
            originalMetatables[getmetatable(remote)] = true
            local meta = getrawmetatable(remote)
            setreadonly(meta, false)
            local oldIndex = meta.__index
            meta.__index = function(self, key)
                if (key == "FireServer" and self:IsA("RemoteEvent")) or (key == "InvokeServer" and self:IsA("RemoteFunction")) then
                    return function(_, ...)
                        local args = {...}
                        if isValidRemoteArgs(args) then
                            revertedRemotes[self] = args
                        end
                        return oldIndex(self, key)(_, unpack(args))
                    end
                end
                return oldIndex(self, key)
            end
            setreadonly(meta, true)
        end
    end
end

for _, remote in pairs(ReplicatedStorage:GetChildren()) do
    if remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction") then
        hookRemote(remote)
    end
end

ReplicatedStorage.ChildAdded:Connect(function(child)
    if child:IsA("RemoteEvent") or child:IsA("RemoteFunction") then
        hookRemote(child)
    end
end)

-- Auto Parry System
local Auto_Parry = {}

Auto_Parry.Get_Balls = function()
    local Balls = {}
    for _, obj in pairs(Workspace.Balls:GetChildren()) do
        if obj:GetAttribute("realBall") then
            obj.CanCollide = false
            table.insert(Balls, obj)
        end
    end
    return Balls
end

Auto_Parry.Get_Ball = function()
    for _, obj in pairs(Workspace.Balls:GetChildren()) do
        if obj:GetAttribute("realBall") then
            obj.CanCollide = false
            return obj
        end
    end
end

Auto_Parry.Closest_Player = function()
    local MaxDist = math.huge
    Closest_Entity = nil
    for _, plr in pairs(Workspace.Alive:GetChildren()) do
        if plr ~= LocalPlayer.Character and plr.PrimaryPart then
            local dist = LocalPlayer:DistanceFromCharacter(plr.PrimaryPart.Position)
            if dist < MaxDist then
                MaxDist = dist
                Closest_Entity = plr
            end
        end
    end
end

Auto_Parry.Is_Curved = function()
    local Ball = Auto_Parry.Get_Ball()
    if not Ball then return false end
    local Zoomies = Ball:FindFirstChild("zoomies")
    if not Zoomies then return false end
    local Ping = Stats.Network.ServerStatsItem["Data Ping"]:GetValue()
    local Velocity = Zoomies.VectorVelocity
    local DirToBall = (LocalPlayer.Character.PrimaryPart.Position - Ball.Position).Unit
    local Dot = DirToBall:Dot(Velocity.Unit)
    local Speed = Velocity.Magnitude
    local Distance = (LocalPlayer.Character.PrimaryPart.Position - Ball.Position).Magnitude
    local ReachTime = (Distance / Speed) - (Ping / 1000)
    if Distance < 20 then return false end
    if Dot < 0.5 - (Ping / 1000) then return true end
    return false
end

local FirstParryDone = false
local Parries = 0

function Auto_Parry.Parry()
    if not FirstParryDone then
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.F, false, game)
        task.wait(0.1)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.F, false, game)
        FirstParryDone = true
    else
        for remote, args in pairs(revertedRemotes) do
            if remote:IsA("RemoteEvent") then
                remote:FireServer(unpack(args))
            elseif remote:IsA("RemoteFunction") then
                remote:InvokeServer(unpack(args))
            end
        end
    end
    if Parries >= 7 then return end
    Parries += 1
    task.delay(0.5, function() Parries -= 1 end)
end

-- Auto Parry Toggle (Your PreSimulation Loop)
local Connections_Manager = {}

CombatTab:Toggle({
    Title = "Auto Parry",
    Default = false,
    Callback = function(state)
        if state then
            Connections_Manager["AutoParry"] = RunService.PreSimulation:Connect(function()
                local Balls = Auto_Parry.Get_Balls()
                if #Balls == 0 then return end
                for _, Ball in pairs(Balls) do
                    if not Ball then continue end
                    local Zoomies = Ball:FindFirstChild("zoomies")
                    if not Zoomies then continue end
                    if Ball:GetAttribute("target") == tostring(LocalPlayer) then
                        local Dist = (LocalPlayer.Character.PrimaryPart.Position - Ball.Position).Magnitude
                        local Speed = Zoomies.VectorVelocity.Magnitude
                        local Ping = Stats.Network.ServerStatsItem["Data Ping"]:GetValue() / 10
                        local Threshold = (Speed / 3.25) + Ping
                        local Curved = Auto_Parry.Is_Curved()
                        if Curved then continue end
                        if Dist <= Threshold then
                            Auto_Parry.Parry()
                        end
                    end
                end
            end)
        else
            if Connections_Manager["AutoParry"] then
                Connections_Manager["AutoParry"]:Disconnect()
                Connections_Manager["AutoParry"] = nil
            end
        end
    end
})

-- Auto Spam Toggle (Your Heartbeat Loop)
CombatTab:Toggle({
    Title = "Auto Spam",
    Default = false,
    Callback = function(state)
        if state then
            Connections_Manager["AutoSpam"] = RunService.Heartbeat:Connect(function()
                local Ball = Auto_Parry.Get_Ball()
                if not Ball then return end
                Auto_Parry.Closest_Player()
                if not Closest_Entity then return end
                local DistToTarget = LocalPlayer:DistanceFromCharacter(Closest_Entity.PrimaryPart.Position)
                if DistToTarget < 40 and Parries < 6 then
                    Auto_Parry.Parry()
                end
            end)
        else
            if Connections_Manager["AutoSpam"] then
                Connections_Manager["AutoSpam"]:Disconnect()
                Connections_Manager["AutoSpam"] = nil
            end
        end
    end
})

-- Manual Spam GUI (Your Exact Draggable GUI)
local MauaulSpam = nil
function ManualSpam()
    if MauaulSpam then MauaulSpam:Destroy() MauaulSpam = nil return end
    MauaulSpam = Instance.new("ScreenGui")
    MauaulSpam.Name = "VHubManualSpam"
    MauaulSpam.Parent = game:GetService("CoreGui")
    MauaulSpam.ResetOnSpawn = false

    local Main = Instance.new("Frame", MauaulSpam)
    Main.Size = UDim2.new(0.23, 0, 0.19, 0)
    Main.Position = UDim2.new(0.414, 0, 0.404, 0)
    Main.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    Main.BorderSizePixel = 0
    Instance.new("UICorner", Main)

    local Indicator = Instance.new("Frame", Main)
    Indicator.Name = "Indicator"
    Indicator.Size = UDim2.new(0.072, 0, 0.12, 0)
    Indicator.Position = UDim2.new(0.028, 0, 0.073, 0)
    Indicator.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    Instance.new("UICorner", Indicator).CornerRadius = UDim.new(1, 0)

    local Title = Instance.new("TextButton", Main)
    Title.Size = UDim2.new(0.668, 0, 0.347, 0)
    Title.Position = UDim2.new(0.164, 0, 0.327, 0)
    Title.BackgroundTransparency = 1
    Title.Text = "Spam"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.Font = Enum.Font.GothamBold
    Title.TextScaled = true

    local Gradient = Instance.new("UIGradient", Title)
    Gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0,0,0)),
        ColorSequenceKeypoint.new(0.75, Color3.fromRGB(255,0,4)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(0,0,0))
    }

    local Info = Instance.new("TextLabel", Main)
    Info.Size = UDim2.new(0.452, 0, 0.173, 0)
    Info.Position = UDim2.new(0.548, 0, 0.827, 0)
    Info.BackgroundTransparency = 1
    Info.Text = "PC: E to spam"
    Info.TextColor3 = Color3.fromRGB(57,57,57)
    Info.TextScaled = true

    local toggled = false
    local connection
    local function toggle()
        toggled = not toggled
        Indicator.BackgroundColor3 = toggled and Color3.new(0,1,0) or Color3.new(1,0,0)
        if toggled then
            connection = RunService.Heartbeat:Connect(function()
                if not toggled then return end
                pcall(Auto_Parry.Parry)
            end)
        else
            if connection then connection:Disconnect() end
        end
    end

    Title.MouseButton1Click:Connect(toggle)
    UserInputService.InputBegan:Connect(function(i,gp)
        if not gp and i.KeyCode == Enum.KeyCode.E then toggle() end
    end)

    -- Draggable
    local dragging, dragInput, dragStart, startPos
    local function update(input)
        local delta = input.Position - dragStart
        Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    Main.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = Main.Position
        end
    end)
    Main.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input == dragInput then update(input) end
    end)
    Main.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)
end

-- Manual Spam Toggle
CombatTab:Toggle({
    Title = "Manual Spam (E)",
    Default = false,
    Callback = function(state)
        if state then ManualSpam() end
    end
})

-- Normal Ball ESP
local function AddNormalESP(ball)
    pcall(function()
        if ball:FindFirstChild("SecretBunkerESP") then return end
        local hl = Instance.new("Highlight")
        hl.Name = "SecretBunkerESP"
        hl.Parent = ball
        hl.FillColor = Color3.new(1, 0, 0)
        hl.OutlineColor = Color3.new(1, 1, 1)
        hl.FillTransparency = 0.5
        hl.OutlineTransparency = 0
    end)
end

VisualTab:Toggle({
    Title = "Normal Ball ESP",
    Default = false,
    Callback = function(v)
        if v then
            for _, ball in pairs(Balls:GetChildren()) do
                if ball:GetAttribute("realBall") then AddNormalESP(ball) end
            end
            Balls.ChildAdded:Connect(function(child)
                task.wait(0.1)
                if child:GetAttribute("realBall") then AddNormalESP(child) end
            end)
        else
            for _, ball in pairs(Balls:GetChildren()) do
                local esp = ball:FindFirstChild("SecretBunkerESP")
                if esp then esp:Destroy() end
            end
        end
    end
})

-- Visualizer Ring
local visualizerEnabled = false
local visualizer = Instance.new("Part")
visualizer.Shape = Enum.PartType.Ball
visualizer.Anchored = true
visualizer.CanCollide = false
visualizer.Material = Enum.Material.ForceField
visualizer.Transparency = 0.5
visualizer.Parent = Workspace
visualizer.Size = Vector3.new(0, 0, 0)

RunService.RenderStepped:Connect(function()
    if not visualizerEnabled then 
        visualizer.Size = Vector3.new(0,0,0)
        return 
    end
    local character = LocalPlayer.Character
    local ball = Auto_Parry.Get_Ball()
    if character and character.PrimaryPart and ball then
        local velocity = ball.Velocity.Magnitude
        local radius = math.clamp((velocity / 2.4) + 10, 15, 200)
        local isHighlighted = character.PrimaryPart:FindFirstChild("Highlight")
        visualizer.Size = Vector3.new(radius, radius, radius)
        visualizer.CFrame = character.PrimaryPart.CFrame
        if isHighlighted then
            visualizer.Color = Color3.fromRGB(255, 255, 255)
        else
            visualizer.Color = Color3.fromRGB(255, 0, 0)
        end
    else
        visualizer.Size = Vector3.new(0, 0, 0)
    end
end)

CombatTab:Toggle({
    Title = "Visualizer Ring",
    Default = false,
    Callback = function(v)
        visualizerEnabled = v
    end
})

CombatTab:Label("Secret Bunker - FINAL COMPLETE")
CombatTab:Label("Auto Parry + Auto Spam + Manual Spam (E Toggle) + Visualizer + ESP")

WindUI:Notify("Secret Bunker Loaded", "Full Script Active - Use Manual Spam (E) Toggle!")
