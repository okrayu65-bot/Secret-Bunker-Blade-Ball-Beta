-- Remote Hook (Clean)
local revertedRemotes = {}
local originalMetatables = {}

local function isValidRemoteArgs(args)
    return #args == 7 and type(args[2]) == "string" and type(args[3]) == "number" and
           typeof(args[4]) == "CFrame" and type(args[5]) == "table" and type(args[6]) == "table" and type(args[7]) == "boolean"
end

local function hookRemote(remote)
    if not revertedRemotes[remote] then
        local meta = getrawmetatable(remote)
        if not originalMetatables[meta] then
            originalMetatables[meta] = true
            setreadonly(meta, false)
            local oldIndex = meta.__index
            meta.__index = function(self, key)
                if key == "FireServer" and self:IsA("RemoteEvent") then
                    return function(_, ...)
                        local args = {...}
                        if isValidRemoteArgs(args) then
                            revertedRemotes[self] = args
                        end
                        return oldIndex(self, "FireServer")(_, table.unpack(args))
                    end
                end
                return oldIndex(self, key)
            end
            setreadonly(meta, true)
        end
    end
end

for _, remote in pairs(game.ReplicatedStorage:GetDescendants()) do
    if remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction") then
        hookRemote(remote)
    end
end

game.ReplicatedStorage.DescendantAdded:Connect(function(child)
    if child:IsA("RemoteEvent") or child:IsA("RemoteFunction") then
        hookRemote(child)
    end
end)

local capturedRemote, capturedArgs
task.spawn(function()
    repeat task.wait(0.5) until next(revertedRemotes)
    for remote, args in pairs(revertedRemotes) do
        if isValidRemoteArgs(args) then
            capturedRemote = remote
            capturedArgs = args
            print("ðŸŽ¯ Locked:", remote.Name)
            break
        end
    end
end)

local lastFire = 0
local cooldown = 0.166
local predThresh = 0.23

local function fireParry()
    if tick() - lastFire < cooldown then return end
    lastFire = tick()
    if capturedRemote and capturedArgs then
        capturedRemote:FireServer(table.unpack(capturedArgs))
    end
end

-- Services
local RS = game:GetService("RunService")
local Players = game:GetService("Players")
local Stats = game:GetService("Stats")
local lp = Players.LocalPlayer
local Balls = workspace:WaitForChild("Balls")

local currentBall = nil
local prevTime = math.huge

-- FIXED Ball Tracker (No Errors)
Balls.ChildAdded:Connect(function(ball)
    if ball:IsA("BasePart") and ball:GetAttribute("realBall") then
        local targetConn
        targetConn = ball:GetAttributeChangedSignal("target"):Connect(function()
            if ball:GetAttribute("target") == lp.Name then
                currentBall = ball
            end
        end)
        ball.AncestryChanged:Connect(function()
            if targetConn then targetConn:Disconnect() end
        end)
    end
end)

Balls.ChildRemoved:Connect(function(ball)
    if currentBall == ball then
        currentBall = nil
    end
end)

-- SINGLE Optimized Loop
local mainConn
local autoParryOn = false
local autoSpamOn = false

local function startMainLoop()
    if mainConn then return end
    mainConn = RS.Heartbeat:Connect(function()
        local char = lp.Character
        if not char or not char:FindFirstChild("Head") then return end
        local head = char.Head

        if not currentBall or currentBall.AssemblyLinearVelocity.Magnitude < 25 then
            prevTime = math.huge
            return
        end

        local dist = (currentBall.Position - head.Position).Magnitude
        local vel = currentBall.AssemblyLinearVelocity
        local dirDot = vel.Unit:Dot((head.Position - currentBall.Position).Unit)

        local ping = Stats.Network.ServerStatsItem["Data Ping"]:GetValue() / 1000
        local thresh = predThresh + (ping * 1.8)
        if vel.Magnitude > 90 then thresh = thresh * 0.9 end

        local timeToHit = dist / vel.Magnitude

        -- Auto Parry: Strict No Double (Skip <7.5, Dir>0.72, Dec*0.92)
        if autoParryOn and dist > 7.5 and dirDot > 0.72 and timeToHit <= thresh and timeToHit < prevTime * 0.92 then
            fireParry()
            prevTime = timeToHit
        else
            prevTime = timeToHit
        end

        -- Clash Spam: Safe 1/CD
        if autoSpamOn and dist <= 10 then
            fireParry()
        end
    end)
end

local function stopMainLoop()
    if mainConn then
        mainConn:Disconnect()
        mainConn = nil
    end
    prevTime = math.huge
end

local function toggleAutoParry(state)
    autoParryOn = state
    if state or autoSpamOn then
        startMainLoop()
    else
        stopMainLoop()
    end
end

local function toggleAutoSpam(state)
    autoSpamOn = state
    if state or autoParryOn then
        startMainLoop()
    else
        stopMainLoop()
    end
end

local function manualSpam()
    for _ = 1, 35 do
        fireParry()
        task.wait(0.03)
    end
end

-- WindUI (Official â€“ Loads Perfect)
local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "Secret Bunker",
    Folder = "SecretBunker",
    IconSize = 44,
    NewElements = true,
    HideSearchBar = false,
    OpenButton = {
        Title = "Open Secret Bunker âš”ï¸",
        CornerRadius = UDim.new(1,0),
        StrokeThickness = 3,
        Enabled = true,
        Draggable = true,
        OnlyMobile = false
    },
    Topbar = {
        Height = 44,
        ButtonsType = "Mac"
    }
})

local CombatTab = Window:Tab({
    Title = "âš”ï¸ Combat",
    Desc = "NO DOUBLE PARRY â€“ Fixed Load",
    Icon = "solar:sword-bold",
    IconColor = Color3.fromHex("#FF6B6B"),
    IconShape = "Square"
})

local ParrySec = CombatTab:Section({
    Title = "Parry Features"
})

ParrySec:Toggle({
    Title = "Auto Parry (Strict Elite)",
    Callback = toggleAutoParry,
    Flag = "AutoParry"
})

ParrySec:Toggle({
    Title = "Clash Spam (Safe 166ms)",
    Callback = toggleAutoSpam,
    Flag = "AutoSpam"
})

ParrySec:Slider({
    Title = "Pred Thresh",
    Min = 0.18,
    Max = 0.35,
    Default = 0.23,
    Rounding = 2,
    Callback = function(v)
        predThresh = v
    end,
    Flag = "PredThresh"
})

ParrySec:Slider({
    Title = "CD (No Double â€“ 0.166 Safe)",
    Min = 0.14,
    Max = 0.25,
    Default = 0.166,
    Rounding = 3,
    Callback = function(v)
        cooldown = v
    end,
    Flag = "Cooldown"
})

ParrySec:Button({
    Title = "Manual Spam (x35 Safe)",
    Callback = manualSpam
})

ParrySec:Button({
    Title = "Unload",
    Callback = function()
        toggleAutoParry(false)
        toggleAutoSpam(false)
        Window:Destroy()
    end
})

WindUI:Notify({
    Title = "Secret Bunker LOADED",
    Content = "Fixed ball tracker + clean code. 166ms CD = ZERO DOUBLE. F once to capture.",
})
