-- Secret Bunker - BLADE BALL AUTO PARRY WITH WINDUI (FULL + FUNCTIONAL TOP RIGHT TOGGLE ICON) ⚔️
local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()

local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local Balls = workspace:WaitForChild("Balls")

-- CURRENT PARRY REMOTE
local ParryRemote = ReplicatedStorage.Remotes:WaitForChild("ParryButtonPress")

-- BALL TRACKING
local targetedBalls = {}
local parriedBalls = {}

Balls.ChildAdded:Connect(function(ball)
    if ball:GetAttribute("realBall") then
        ball:GetAttributeChangedSignal("target"):Connect(function()
            task.wait(0.01)
            if ball:GetAttribute("target") == Player.Name then
                targetedBalls[ball] = true
                parriedBalls[ball] = 0
            end
        end)
    end
end)

Balls.ChildRemoved:Connect(function(ball)
    targetedBalls[ball] = nil
    parriedBalls[ball] = nil
end)

-- MAIN LOOP
local mainConn
local autoParryOn = false
local autoSpamOn = false

local function startMainLoop()
    if mainConn then return end
    mainConn = RunService.Heartbeat:Connect(function()
        if not Player.Character or not Player.Character:FindFirstChild("Head") then return end
        local head = Player.Character.Head

        local bestBall = nil
        local bestThreat = 0

        for ball in pairs(targetedBalls) do
            if ball and ball.Parent and ball.AssemblyLinearVelocity.Magnitude > 30 and (parriedBalls[ball] or 0) < 2 then
                local dist = (ball.Position - head.Position).Magnitude
                local velMag = ball.AssemblyLinearVelocity.Magnitude
                local dirDot = ball.AssemblyLinearVelocity.Unit:Dot((head.Position - ball.Position).Unit)
                local timeToHit = dist / math.max(velMag, 1)

                if dirDot > 0.8 then
                    local threat = (1 / timeToHit) * dirDot
                    if threat > bestThreat then
                        bestThreat = threat
                        bestBall = ball
                    end
                end
            end
        end

        if bestBall then
            local timeToHit = (bestBall.Position - head.Position).Magnitude / math.max(bestBall.AssemblyLinearVelocity.Magnitude, 1)

            if autoParryOn and timeToHit <= 0.45 then
                ParryRemote:Fire()
                parriedBalls[bestBall] = (parriedBalls[bestBall] or 0) + 1
                task.delay(3, function() parriedBalls[bestBall] = 0 end)
            end

            if autoSpamOn and timeToHit <= 0.35 then
                ParryRemote:Fire()
            end
        end
    end)
end

local function stopMainLoop()
    if mainConn then mainConn:Disconnect() mainConn = nil end
end

-- MANUAL SPAM UI
local spamClicking = false
local spamUI = nil

local function createSpamUI()
    if spamUI then spamUI:Destroy() end
    spamUI = WindUI:CreateWindow({Title = "Manual Spam", Size = UDim2.new(0,300,0,180)})
    local tab = spamUI:Tab({Title = "Spam"})
    local sec = tab:Section({Title = "Hold to Spam"})
    sec:Button({Title = "START SPAM", Callback = function()
        spamClicking = not spamClicking
        if spamClicking then
            task.spawn(function()
                while spamClicking do
                    ParryRemote:Fire()
                    task.wait(0.008)
                end
            end)
        end
    end})
    sec:Button({Title = "STOP", Callback = function() spamClicking = false end})
    spamUI:Open()
end

-- MAIN WINDOW WITH FUNCTIONAL TOP RIGHT TOGGLE ICON
local Window = WindUI:CreateWindow({
    Title = "Secret Bunker",
    Icon = "door-open",  -- This creates the clickable toggle icon in top right
    Author = "by Rayu",
    Folder = "SecretBunker2025",
    
    Size = UDim2.fromOffset(580, 460),
    MinSize = Vector2.new(560, 350),
    MaxSize = Vector2.new(850, 560),
    Transparent = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 200,
    BackgroundImageTransparency = 0.42,
    HideSearchBar = true,
    ScrollBarEnabled = false,
    
    User = {
        Enabled = true,
        Anonymous = true,
    },
})

local CombatTab = Window:Tab({
    Title = "Combat"
})

local ParrySec = CombatTab:Section({
    Title = "Auto Parry"
})

ParrySec:Toggle({
    Title = "Auto Parry",
    Callback = function(state)
        autoParryOn = state
        if state or autoSpamOn then startMainLoop() else stopMainLoop() end
    end
})

ParrySec:Toggle({
    Title = "Auto Spam",
    Callback = function(state)
        autoSpamOn = state
        if state or autoParryOn then startMainLoop() else stopMainLoop() end
    end
})

ParrySec:Button({
    Title = "Manual Spam",
    Callback = createSpamUI
})

ParrySec:Button({
    Title = "Unload",
    Callback = function()
        stopMainLoop()
        spamClicking = false
        if spamUI then spamUI:Destroy() end
        Window:Destroy()
    end
})

WindUI:Notify({
    Title = "Secret Bunker Loaded",
    Content = "Click the door icon (top right) to toggle UI",
    Duration = 10
})
