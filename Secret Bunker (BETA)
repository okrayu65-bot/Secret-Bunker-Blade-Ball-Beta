-- Secret Bunker - MAX POWER AUTO PARRY + AUTO SPAM âš”ï¸
local revertedRemotes = {}
local originalMetatables = {}

local function isValidRemoteArgs(args)
    return #args == 7 and type(args[2]) == "string" and type(args[3]) == "number" and
           typeof(args[4]) == "CFrame" and type(args[5]) == "table" and type(args[6]) == "table" and type(args[7]) == "boolean"
end

local function hookRemote(remote)
    if not revertedRemotes[remote] then
        local meta = getrawmetatable(remote)
        if not originalMetatables[meta] then
            originalMetatables[meta] = true
            setreadonly(meta, false)
            local oldIndex = meta.__index
            meta.__index = function(self, key)
                if key == "FireServer" and self:IsA("RemoteEvent") then
                    return function(_, ...)
                        local args = {...}
                        if isValidRemoteArgs(args) then
                            revertedRemotes[self] = args
                        end
                        return oldIndex(self, "FireServer")(_, table.unpack(args))
                    end
                end
                return oldIndex(self, key)
            end
            setreadonly(meta, true)
        end
    end
end

for _, remote in pairs(game.ReplicatedStorage:GetDescendants()) do
    if remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction") then
        hookRemote(remote)
    end
end

game.ReplicatedStorage.DescendantAdded:Connect(function(child)
    if child:IsA("RemoteEvent") or child:IsA("RemoteFunction") then
        hookRemote(child)
    end
end)

-- AUTO CAPTURE
local capturedRemote, capturedArgs
task.spawn(function()
    local attempts = 0
    repeat
        task.wait(1)
        attempts += 1
        for remote, args in pairs(revertedRemotes) do
            if isValidRemoteArgs(args) then
                capturedRemote = remote
                capturedArgs = args
                print("ðŸŽ¯ POWER CAPTURED:", remote.Name)
                return
            end
        end
        if attempts > 30 then break end
    until capturedRemote
end)

local lastFire = 0
local cooldown = 0.10  -- ULTRA POWER CD
local predThresh = 0.23

local function fireParry()
    if not capturedRemote then return end
    if tick() - lastFire < cooldown then return end
    lastFire = tick()
    capturedRemote:FireServer(table.unpack(capturedArgs))
end

-- Services
local RS = game:GetService("RunService")
local Players = game:GetService("Players")
local Stats = game:GetService("Stats")
local lp = Players.LocalPlayer
local Balls = workspace:WaitForChild("Balls")

-- MAX POWER MULTI-BALL
local targetedBalls = {}
local ballHistory = {}

Balls.ChildAdded:Connect(function(ball)
    if ball:IsA("BasePart") and ball:GetAttribute("realBall") then
        ball:GetAttributeChangedSignal("target"):Connect(function()
            task.wait(0.01)
            if ball:GetAttribute("target") == lp.Name then
                targetedBalls[ball] = true
                print("ðŸŽ¾ POWER TARGET:", ball.Name)
            end
        end)
        ball.AncestryChanged:Connect(function()
            targetedBalls[ball] = nil
        end)
    end
end)

Balls.ChildRemoved:Connect(function(ball)
    targetedBalls[ball] = nil
    ballHistory[ball] = nil
end)

local function getSmoothedDir(ball, headPos)
    local history = ballHistory[ball] or {}
    table.insert(history, 1, (headPos - ball.Position).Unit)
    if #history > 7 then table.remove(history) end  -- ULTRA SMOOTH
    ballHistory[ball] = history
    
    local sum = Vector3.new()
    for _, dir in ipairs(history) do sum = sum + dir end
    return sum.Unit
end

-- MAX POWER LOOP
local mainConn
local autoParryOn = false
local autoSpamOn = false

local function startMainLoop()
    if mainConn then return end
    mainConn = RS.Heartbeat:Connect(function()
        local char = lp.Character
        if not char or not char:FindFirstChild("Head") then return end
        local head = char.Head

        -- POWER BEST BALL
        local bestBall, bestScore = nil, -math.huge
        for ball, _ in pairs(targetedBalls) do
            if ball and ball.Parent and ball.AssemblyLinearVelocity.Magnitude > 15 then
                local dist = (ball.Position - head.Position).Magnitude
                local velMag = ball.AssemblyLinearVelocity.Magnitude
                local score = -dist*0.7 + (velMag / 30)  -- MAX POWER SCORING
                if score > bestScore then
                    bestScore = score
                    bestBall = ball
                end
            end
        end

        if not bestBall then return end

        local dist = (bestBall.Position - head.Position).Magnitude
        local vel = bestBall.AssemblyLinearVelocity
        local velMag = vel.Magnitude
        local dir = getSmoothedDir(bestBall, head.Position)
        local dirDot = vel.Unit:Dot(dir)

        local ping = Stats.Network.ServerStatsItem["Data Ping"]:GetValue() / 1000
        local baseThresh = predThresh + (ping * 5)  -- GOD PING COMP
        
        -- MAX POWER TIERS (dirDot 0.30 = CATCHES EVERYTHING)
        local isFast = velMag > 90; local isUltra = velMag > 500
        local isGod = velMag > 2000; local isMax = velMag > 10000
        
        local thresh, minDist, minDirDot, decayMult, spamDist
        if isMax then
            thresh, minDist, minDirDot, decayMult, spamDist = 0.002, 1.5, 0.30, 0.5, 5
        elseif isGod then
            thresh, minDist, minDirDot, decayMult, spamDist = 0.006, 2.0, 0.32, 0.60, 6
        elseif isUltra then
            thresh, minDist, minDirDot, decayMult, spamDist = 0.015, 3.0, 0.40, 0.70, 8
        elseif isFast then
            thresh, minDist, minDirDot, decayMult, spamDist = baseThresh * 0.75, 4.0, 0.50, 0.80, 18
        else
            thresh, minDist, minDirDot, decayMult, spamDist = baseThresh, 5.0, 0.60, 0.85, 22
        end

        local timeToHit = dist / math.max(velMag, 1)

        -- MAX POWER AUTO PARRY
        local shouldParry = autoParryOn and dist > minDist and dirDot > minDirDot and 
                           timeToHit <= thresh and timeToHit < prevTime * decayMult
        
        if shouldParry then
            fireParry()
            prevTime = timeToHit
            return
        else
            prevTime = timeToHit
        end

        -- MAX POWER AUTO SPAM
        if autoSpamOn and dist <= spamDist then
            fireParry()
        elseif dist <= 25 then  -- GOD SAFETY NET
            fireParry()
        end
    end)
end

local function stopMainLoop()
    if mainConn then
        mainConn:Disconnect()
        mainConn = nil
    end
    prevTime = math.huge
end

local function toggleAutoParry(state)
    autoParryOn = state
    WindUI:Notify({
        Title = state and "ðŸ›¡ï¸ AUTO PARRY MAX POWER ON" or "âŒ Auto Parry OFF",
        Duration = 3
    })
    if state or autoSpamOn then startMainLoop() else stopMainLoop() end
end

local function toggleAutoSpam(state)
    autoSpamOn = state
    WindUI:Notify({
        Title = state and "âš¡ AUTO SPAM MAX POWER ON" or "âš¡ Auto Spam OFF",
        Duration = 3
    })
    if state or autoParryOn then startMainLoop() else stopMainLoop() end
end

local function manualSpam()
    for _ = 1, 150 do fireParry() task.wait(0.01) end  -- x150 GOD SPAM
end

-- WindUI
local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "Secret Bunker",
    Folder = "SecretBunker",
    IconSize = 44,
    NewElements = true,
    HideSearchBar = false,
    OpenButton = {
        Title = "Open Secret Bunker âš”ï¸",
        CornerRadius = UDim.new(1,0),
        StrokeThickness = 3,
        Enabled = true,
        Draggable = true,
        OnlyMobile = false
    },
    Topbar = {
        Height = 44,
        ButtonsType = "Mac"
    }
})

local CombatTab = Window:Tab({
    Title = "âš”ï¸ Combat",
    Desc = "MAX POWER Auto Parry + Auto Spam",
    Icon = "solar:sword-bold",
    IconColor = Color3.fromHex("#FF6B6B"),
    IconShape = "Square"
})

local ParrySec = CombatTab:Section({
    Title = "MAX POWER"
})

ParrySec:Toggle({
    Title = "Auto Parry",
    Callback = toggleAutoParry,
    Flag = "AutoParry"
})

ParrySec:Toggle({
    Title = "Auto Spam",
    Callback = toggleAutoSpam,
    Flag = "AutoSpam"
})

ParrySec:Slider({
    Title = "Prediction",
    Min = 0.18, Max = 0.35, Default = 0.23, Rounding = 2,
    Callback = function(v) predThresh = v end,
    Flag = "Pred"
})

ParrySec:Slider({
    Title = "Cooldown (0.10 Power)",
    Min = 0.08, Max = 0.18, Default = 0.10, Rounding = 3,
    Callback = function(v) cooldown = v end,
    Flag = "CD"
})

ParrySec:Button({
    Title = "God Spam (x150)",
    Callback = manualSpam
})

ParrySec:Button({
    Title = "Debug",
    Callback = function()
        local count = 0
        for ball, _ in pairs(targetedBalls) do
            if ball and ball.Parent then count += 1 end
        end
        WindUI:Notify({
            Title = "Power Debug",
            Content = count .. " balls | MAX POWER ACTIVE",
            Duration = 4
        })
    end
})

ParrySec:Button({
    Title = "Unload",
    Callback = function()
        toggleAutoParry(false)
        toggleAutoSpam(false)
        Window:Destroy()
    end
})

WindUI:Notify({
    Title = "âš¡ MAX POWER LOADED",
    Content = "Auto Parry + Auto Spam = TOTAL DOMINATION",
    Duration = 8
})
